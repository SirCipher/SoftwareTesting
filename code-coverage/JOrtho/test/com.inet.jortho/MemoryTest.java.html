<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>MemoryTest.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">AllTests (07-Apr-2019 21:21:31)</a> &gt; <a href="../../index.html" class="el_group">JOrtho</a> &gt; <a href="../index.html" class="el_bundle">test</a> &gt; <a href="index.source.html" class="el_package">com.inet.jortho</a> &gt; <span class="el_source">MemoryTest.java</span></div><h1>MemoryTest.java</h1><pre class="source lang-java linenums">/*
 * Created on 14.10.2008
 *
 * To change the template for this generated file go to
 * Window - Preferences - Java - Code Generation - Code and Comments
 */
package com.inet.jortho;

import java.awt.Toolkit;

import javax.swing.*;

import junit.framework.TestCase;

<span class="nc" id="L15">public class MemoryTest extends TestCase {</span>
    
    static{
<span class="nc" id="L18">        AllTests.init();</span>
<span class="nc" id="L19">    }</span>
    
    /**
     * Create a large amount of languages menus
     */
    public void testCreateLanguagesMenu() throws Exception{
<span class="nc" id="L25">        SpellChecker.createLanguagesMenu();</span>
        
<span class="nc" id="L27">        long memoryBefore = usedMemory();</span>
        
<span class="nc bnc" id="L29" title="All 2 branches missed.">        for( int i=0; i&lt; 10000; i++ ){</span>
<span class="nc" id="L30">            SpellChecker.createLanguagesMenu();</span>
        }
        
<span class="nc" id="L33">        long memoryAfter = usedMemory();</span>
        
<span class="nc bnc" id="L35" title="All 2 branches missed.">        if (memoryBefore + 100000 &lt; memoryAfter ){</span>
<span class="nc" id="L36">            fail(&quot;Memory Leak SpellChecker.createLanguagesMenu. memory before:&quot; + (memoryBefore/1024) + &quot; KB  memory after:&quot; + (memoryAfter/1024) +&quot; KB&quot; );</span>
        }
<span class="nc" id="L38">    }</span>

    /**
     * Create many JTextPane and register the spell checker
     */
    public void testRegister() throws Exception{
        // Create a large text
<span class="nc" id="L45">        StringBuffer buf = new StringBuffer();</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">        for( int i=0; i&lt;1000; i++){</span>
<span class="nc" id="L47">            buf.append( &quot;This is a very simple sentence.\n&quot; );</span>
        }
<span class="nc" id="L49">        String text = buf.toString();</span>
<span class="nc" id="L50">        buf = null;</span>
        
<span class="nc" id="L52">        JTextPane textPane1 = new JTextPane();</span>
<span class="nc" id="L53">        textPane1.setText( text );</span>
<span class="nc" id="L54">        SpellChecker.register( textPane1 );</span>
<span class="nc" id="L55">        textPane1 = null;</span>
        
<span class="nc" id="L57">        long memoryBefore = usedMemory();</span>
        
<span class="nc bnc" id="L59" title="All 2 branches missed.">        for( int i=0; i&lt; 100; i++ ){</span>
<span class="nc" id="L60">            JTextPane textPane = new JTextPane();</span>
<span class="nc" id="L61">            textPane.setText( text );</span>
<span class="nc" id="L62">            SpellChecker.register( textPane );</span>
            // there will be some thread started, we give it a little time
<span class="nc" id="L64">            System.err.println(usedMemory());</span>
<span class="nc" id="L65">            Thread.sleep( 10 );</span>
        }
        
<span class="nc" id="L68">        long memoryAfter = usedMemory();</span>
        
<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (memoryBefore + 1000000 &lt; memoryAfter ){</span>
<span class="nc" id="L71">            fail(&quot;Memory Leak SpellChecker.register. memory before:&quot; + (memoryBefore/1024) + &quot; KB  memory after:&quot; + (memoryAfter/1024) +&quot; KB&quot; );</span>
        }
<span class="nc" id="L73">    }</span>

    /**
     * Start the gc and caluculate the the current used memory.
     */
    private long usedMemory() throws Exception{
<span class="nc" id="L79">        Runtime runtime = Runtime.getRuntime();</span>
<span class="nc" id="L80">        long last = Long.MAX_VALUE;</span>
        while(true){
<span class="nc" id="L82">            Thread.sleep( 1 );</span>
            // empty the event loop, because it hold many references
<span class="nc bnc" id="L84" title="All 2 branches missed.">            if( Toolkit.getDefaultToolkit().getSystemEventQueue().peekEvent() != null ){</span>
<span class="nc" id="L85">                continue;</span>
            }
<span class="nc" id="L87">            System.runFinalization();</span>
<span class="nc" id="L88">            System.gc();</span>
<span class="nc" id="L89">            Thread.sleep( 10 );</span>
<span class="nc" id="L90">            long current = runtime.totalMemory() - runtime.freeMemory();</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">            if(current &lt; last){</span>
                // if the value are reduced then wait for more reducing
<span class="nc" id="L93">                last = current;</span>
<span class="nc" id="L94">            } else {</span>
<span class="nc" id="L95">                return last;</span>
            }
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span>AllTests (07-Apr-2019 21:21:31)</div></body></html>
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>CheckerListener.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">AllTests (07-Apr-2019 21:21:31)</a> &gt; <a href="../../index.html" class="el_group">JOrtho</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">com.inet.jortho</a> &gt; <span class="el_source">CheckerListener.java</span></div><h1>CheckerListener.java</h1><pre class="source lang-java linenums">/*
 *  JOrtho
 *
 *  Copyright (C) 2005-2010 by i-net software
 *
 *  This program is free software; you can redistribute it and/or
 *  modify it under the terms of the GNU General Public License as 
 *  published by the Free Software Foundation; either version 2 of the
 *  License, or (at your option) any later version. 
 *
 *  This program is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *  General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program; if not, write to the Free Software
 *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307
 *  USA.
 *  
 * Created on 25.02.2008
 */
package com.inet.jortho;

import java.awt.Component;
import java.awt.Point;
import java.awt.Rectangle;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.List;
import java.util.Locale;

import javax.swing.JComponent;
import javax.swing.JMenu;
import javax.swing.JMenuItem;
import javax.swing.JPopupMenu;
import javax.swing.event.PopupMenuEvent;
import javax.swing.event.PopupMenuListener;
import javax.swing.text.BadLocationException;
import javax.swing.text.Caret;
import javax.swing.text.Document;
import javax.swing.text.JTextComponent;
import javax.swing.text.Utilities;

/**
 * Is used from CheckerMenu and CheckerPopup to handle the user events.
 * @author Volker Berlin
 */
public class CheckerListener implements PopupMenuListener, LanguageChangeListener {

    private final JComponent          menu;

    private Dictionary                dictionary;

    private Locale                    locale;

    private final SpellCheckerOptions options;

    /**
     * Create a PopupMenuListener
     * 
     * @param menu
     *            a JMenu or JPopuup
     * @param options
     *            current spell checker options
     */
<span class="fc" id="L67">    public CheckerListener( JComponent menu, SpellCheckerOptions options ) {</span>
<span class="fc" id="L68">        this.menu = menu;</span>
<span class="pc bpc" id="L69" title="1 of 2 branches missed.">        this.options = options == null ? SpellChecker.getOptions() : options;</span>
<span class="fc" id="L70">        SpellChecker.addLanguageChangeLister( this );</span>
<span class="fc" id="L71">        dictionary = SpellChecker.getCurrentDictionary();</span>
<span class="fc" id="L72">        locale = SpellChecker.getCurrentLocale();</span>
<span class="fc" id="L73">    }</span>

    /**
     * {@inheritDoc}
     */
    public void popupMenuCanceled( PopupMenuEvent e ) {
        /* empty */
<span class="nc" id="L80">    }</span>

    /**
     * {@inheritDoc}
     */
    public void popupMenuWillBecomeInvisible( PopupMenuEvent e ) {
        /* empty */
<span class="nc" id="L87">    }</span>

    /**
     * {@inheritDoc}
     */
    public void popupMenuWillBecomeVisible( PopupMenuEvent ev ) {
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if( dictionary == null) {</span>
<span class="nc" id="L94">            menu.setEnabled( false );</span>
<span class="nc" id="L95">            return;</span>
        }

<span class="nc" id="L98">        JPopupMenu popup = (JPopupMenu)ev.getSource();</span>

<span class="nc" id="L100">        Component invoker = popup.getInvoker();</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if( invoker instanceof JTextComponent ) {</span>
<span class="nc" id="L102">            final JTextComponent jText = (JTextComponent)invoker;</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">            if( !jText.isEditable() ) {</span>
                // Suggestions only for editable text components
<span class="nc" id="L105">                menu.setEnabled( false );</span>
<span class="nc" id="L106">                return;</span>
            }
            try {
<span class="nc" id="L109">                int offs = getCursorPosition( jText );</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">                if( offs &lt; 0 ) {</span>
                    // occur if there nothing under the mouse pointer
<span class="nc" id="L112">                    menu.setEnabled( false );</span>
<span class="nc" id="L113">                    return;</span>
                }
                
                // get the word from current position
<span class="nc" id="L117">                final int begOffs = Utilities.getWordStart( jText, offs );</span>
<span class="nc" id="L118">                final int endOffs = Utilities.getWordEnd( jText, offs );</span>
<span class="nc" id="L119">                final String word = jText.getText( begOffs, endOffs - begOffs );</span>

                //find the first invalid word from current position, use the Tokenizer that it is ever compatible with the red zigzag line
<span class="nc" id="L122">                Tokenizer tokenizer = new Tokenizer( jText, dictionary, locale, offs, options );</span>
                String invalidWord;
<span class="nc bnc" id="L124" title="All 2 branches missed.">                do {</span>
<span class="nc" id="L125">                    invalidWord = tokenizer.nextInvalidWord();</span>
<span class="nc" id="L126">                } while( tokenizer.getWordOffset() &lt; begOffs );</span>
<span class="nc" id="L127">                menu.removeAll();</span>

<span class="nc bnc" id="L129" title="All 2 branches missed.">                if( !word.equals( invalidWord ) ) {</span>
                    // the current word is not invalid
<span class="nc" id="L131">                    menu.setEnabled( false );</span>
<span class="nc" id="L132">                    return;</span>
                }

<span class="nc" id="L135">                List&lt;Suggestion&gt; list = dictionary.searchSuggestions( word );</span>

                //Disable then menu item if there are no suggestions
<span class="nc bnc" id="L138" title="All 2 branches missed.">                menu.setEnabled( list.size() &gt; 0 );</span>

<span class="nc bnc" id="L140" title="All 4 branches missed.">                boolean needCapitalization = tokenizer.isFirstWordInSentence() &amp;&amp; Utils.isFirstCapitalized( word );</span>

<span class="nc" id="L142">                addSuggestionMenuItem( jText, begOffs, endOffs, list, needCapitalization );</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">                addMenuItemAddToDictionary( jText, word, list.size() &gt; 0 );</span>
<span class="nc" id="L144">            } catch( BadLocationException ex ) {</span>
<span class="nc" id="L145">            	SpellChecker.getMessageHandler().handleException( ex );</span>
            }
        }
<span class="nc" id="L148">    }</span>
    
    /**
     * Get the cursor position for the popup menu
     * 
     * @param jText
     *            current JTextComponent
     * @return the current position
     * @throws BadLocationException
     *             should never occur
     */
    protected int getCursorPosition( JTextComponent jText ) throws BadLocationException {
<span class="nc" id="L160">        Caret caret = jText.getCaret();</span>
        int offs;
<span class="nc" id="L162">        Point p = null;</span>
        try {
<span class="nc" id="L164">            p = jText.getMousePosition();</span>
<span class="nc" id="L165">        } catch( RuntimeException e ) { // hack for http://bugs.sun.com/view_bug.do?bug_id=8012026</span>
<span class="nc" id="L166">            SpellChecker.getMessageHandler().handleException( e );</span>
        }
<span class="nc bnc" id="L168" title="All 2 branches missed.">        if( p != null ) {</span>
            // use position from mouse click and not from editor cursor position 
<span class="nc" id="L170">            offs = jText.viewToModel( p );</span>
            // calculate rectangle of line
<span class="nc" id="L172">            int startPos = Utilities.getRowStart( jText, offs );</span>
<span class="nc" id="L173">            int endPos = Utilities.getRowEnd( jText, offs );</span>
<span class="nc" id="L174">            Rectangle bounds = jText.modelToView( startPos ).union( jText.modelToView( endPos ) );</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">            if( !bounds.contains( p ) ){</span>
<span class="nc" id="L176">                return -1; // mouse is outside of text</span>
            }
        } else {
<span class="nc" id="L179">            offs = Math.min( caret.getDot(), caret.getMark() );</span>
        }
<span class="nc" id="L181">        Document doc = jText.getDocument();</span>
<span class="nc bnc" id="L182" title="All 6 branches missed.">        if( offs &gt; 0 &amp;&amp; (offs &gt;= doc.getLength() || Character.isWhitespace( doc.getText( offs, 1 ).charAt( 0 ) )) ) {</span>
            // if the next character is a white space then use the word on the left site
<span class="nc" id="L184">            offs--;</span>
        }
<span class="nc" id="L186">        return offs;</span>
    }
    
    /**
     * Add menu items to the with suggestions to the menu.
     * 
     * @param jText
     *            current JTextComponent
     * @param begOffs
     *            offset of the current word in the JTextComponent, need for replacement
     * @param endOffs
     *            end of the current word in the JTextComponent, need for replacement
     * @param list
     *            a list with suggestions
     * @param needCapitalization
     *            if the first letter of the suggestion should capitalized
     */
    protected void addSuggestionMenuItem( final JTextComponent jText, final int begOffs, final int endOffs, List&lt;Suggestion&gt; list, boolean needCapitalization ) {
<span class="nc bnc" id="L204" title="All 4 branches missed.">        for( int i = 0; i &lt; list.size() &amp;&amp; i &lt; options.getSuggestionsLimitMenu(); i++ ) {</span>
<span class="nc" id="L205">            Suggestion sugestion = list.get( i );</span>
<span class="nc" id="L206">            String sugestionWord = sugestion.getWord();</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">            if( needCapitalization ) {</span>
<span class="nc" id="L208">                sugestionWord = Utils.getCapitalized( sugestionWord );</span>
            }
<span class="nc" id="L210">            JMenuItem item = new JMenuItem( sugestionWord );</span>
<span class="nc" id="L211">            menu.add( item );</span>
<span class="nc" id="L212">            final String newWord = sugestionWord;</span>
<span class="nc" id="L213">            item.addActionListener( new ActionListener() {</span>

                public void actionPerformed( ActionEvent e ) {
<span class="nc" id="L216">                    jText.setSelectionStart( begOffs );</span>
<span class="nc" id="L217">                    jText.setSelectionEnd( endOffs );</span>
<span class="nc" id="L218">                    jText.replaceSelection( newWord );</span>
<span class="nc" id="L219">                }</span>

            } );
        }
<span class="nc" id="L223">    }</span>
    
    /**
     * Add the menu item &quot;Add to Dictionary&quot; at the end of the menu if a user dictionary is available.
     * 
     * @param jText
     *            current JTextComponent
     * @param word
     *            current word, which can be add
     * @param addSeparator
     *            true, add a separator before the menu item
     */
    protected void addMenuItemAddToDictionary( JTextComponent jText, String word, boolean addSeparator ) {
<span class="nc" id="L236">        UserDictionaryProvider provider = SpellChecker.getUserDictionaryProvider();</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if( provider == null ) {</span>
<span class="nc" id="L238">            return;</span>
        }
<span class="nc" id="L240">        JMenuItem addToDic = new JMenuItem( new AddWordAction( jText, word ) );</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">        if( addSeparator ) {</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">            if( menu instanceof JMenu ) {</span>
<span class="nc" id="L243">                ((JMenu)menu).addSeparator();</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">            } else if( menu instanceof JPopupMenu ) {</span>
<span class="nc" id="L245">                ((JPopupMenu)menu).addSeparator();</span>
            }
        }
<span class="nc" id="L248">        menu.add( addToDic );</span>
<span class="nc" id="L249">        menu.setEnabled( true );</span>
<span class="nc" id="L250">    }</span>

    /**
     * {@inheritDoc}
     */
    public void languageChanged( LanguageChangeEvent ev ) {
<span class="nc" id="L256">        dictionary = SpellChecker.getCurrentDictionary();</span>
<span class="nc" id="L257">        locale = SpellChecker.getCurrentLocale();</span>
<span class="nc" id="L258">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span>AllTests (07-Apr-2019 21:21:31)</div></body></html>
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>SpellCheckerDialog.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">AllTests (07-Apr-2019 21:21:31)</a> &gt; <a href="../../index.html" class="el_group">JOrtho</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">com.inet.jortho</a> &gt; <span class="el_source">SpellCheckerDialog.java</span></div><h1>SpellCheckerDialog.java</h1><pre class="source lang-java linenums">/*
 *  JOrtho
 *
 *  Copyright (C) 2005-2008 by i-net software
 *
 *  This program is free software; you can redistribute it and/or
 *  modify it under the terms of the GNU General Public License as 
 *  published by the Free Software Foundation; either version 2 of the
 *  License, or (at your option) any later version. 
 *
 *  This program is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *  General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program; if not, write to the Free Software
 *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307
 *  USA.
 *  
 *  Created on 10.11.2005
 */
package com.inet.jortho;

import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyEvent;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.util.*;
import java.util.List;

import javax.imageio.ImageIO;
import javax.swing.*;
import javax.swing.event.*;
import javax.swing.text.*;

/**
 * The Dialog for continues checking the orthography.
 * @author Volker Berlin
 */
class SpellCheckerDialog extends JDialog implements ActionListener {

    private JTextComponent jText;
    private Dictionary dictionary;
    private Tokenizer tok;
    private boolean isDictionaryModify;
    private final SpellCheckerOptions options;
    

<span class="nc" id="L52">    final private JLabel notFound = Utils.getLabel( null );</span>
<span class="nc" id="L53">    final private JTextField word = Utils.getTextField(); </span>
<span class="nc" id="L54">    final private JList suggestionsList = Utils.getList();</span>
    
<span class="nc" id="L56">    final private JButton ignore      = Utils.getButton( &quot;ignore&quot; );</span>
<span class="nc" id="L57">    final private JButton ignoreAll   = Utils.getButton( &quot;ignoreAll&quot; );</span>
<span class="nc" id="L58">    final private JButton addToDic    = Utils.getButton( &quot;addToDictionary&quot; );</span>
<span class="nc" id="L59">    final private JButton editDic     = Utils.getButton( &quot;editDictionary&quot; );</span>
<span class="nc" id="L60">    final private JButton change      = Utils.getButton( &quot;change&quot; );</span>
<span class="nc" id="L61">    final private JButton changeAll   = Utils.getButton( &quot;changeAll&quot; );</span>
<span class="nc" id="L62">    final private JButton about       = Utils.getButton( &quot;about&quot; );</span>
<span class="nc" id="L63">    final private JButton close       = Utils.getButton( &quot;close&quot; );</span>
    
    /** List of ignore all words */  
<span class="nc" id="L66">    final private ArrayList&lt;String&gt; ignoreWords = new ArrayList&lt;String&gt;();</span>
    /** Map of change all words */
<span class="nc" id="L68">    final private HashMap&lt;String,String&gt; changeWords = new HashMap&lt;String,String&gt;();</span>

    SpellCheckerDialog(Dialog owner) throws HeadlessException {
<span class="nc" id="L71">        this(owner, false, null);</span>
<span class="nc" id="L72">    }</span>


    SpellCheckerDialog(Dialog owner, boolean modal, SpellCheckerOptions options){
<span class="nc" id="L76">        super(owner, modal);</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">        this.options = options == null ? SpellChecker.getOptions() : options;</span>
<span class="nc" id="L78">        init();</span>
<span class="nc" id="L79">    }</span>


    SpellCheckerDialog(Frame owner){
<span class="nc" id="L83">        this(owner, false, null);</span>
<span class="nc" id="L84">    }</span>
    

    SpellCheckerDialog(Frame owner, boolean modal, SpellCheckerOptions options){
<span class="nc" id="L88">        super(owner, modal);</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">        this.options = options == null ? SpellChecker.getOptions() : options;</span>
<span class="nc" id="L90">        init();</span>
<span class="nc" id="L91">    }</span>

    final private void init(){
<span class="nc" id="L94">        Utils.setDialogIcon( this );</span>
<span class="nc" id="L95">        setDefaultCloseOperation( WindowConstants.DISPOSE_ON_CLOSE );</span>
<span class="nc" id="L96">        Container cont = getContentPane();</span>
<span class="nc" id="L97">        cont.setLayout(new GridBagLayout());</span>
<span class="nc" id="L98">        Insets insetL = new Insets(8,8,0,8);</span>
<span class="nc" id="L99">        Insets insetR = new Insets(8,0,0,8);</span>
        
<span class="nc" id="L101">        cont.add( Utils.getLabel(Utils.getResource(&quot;notInDictionary&quot;)+&quot;:&quot;), new GridBagConstraints( 1, 1, 1, 1, 0.0, 0.0, GridBagConstraints.SOUTHWEST ,GridBagConstraints.NONE, insetL, 0, 0));</span>
        
<span class="nc" id="L103">        notFound.setForeground(Color.RED);</span>
<span class="nc" id="L104">        notFound.setText(&quot;xxxxxxxxxx&quot;);</span>
<span class="nc" id="L105">        cont.add( notFound, new GridBagConstraints( 2, 1, 1, 1, 0.0, 0.0, GridBagConstraints.SOUTHWEST ,GridBagConstraints.NONE, insetL, 0, 0));</span>
        
<span class="nc" id="L107">        cont.add( word, new GridBagConstraints( 1, 2, 2, 1, 1.0, 0.0, GridBagConstraints.NORTHWEST ,GridBagConstraints.HORIZONTAL, insetL, 0, 0));</span>
        
<span class="nc" id="L109">        cont.add( Utils.getLabel(Utils.getResource(&quot;suggestions&quot;)+&quot;:&quot;), new GridBagConstraints( 1, 3, 2, 1, 0.0, 0.0, GridBagConstraints.SOUTHWEST ,GridBagConstraints.NONE, insetL, 0, 0));</span>
<span class="nc" id="L110">        JScrollPane scrollPane = new JScrollPane(suggestionsList);</span>
<span class="nc" id="L111">        cont.add( scrollPane, new GridBagConstraints( 1, 4, 2, 6, 1.0, 1.0, GridBagConstraints.NORTHWEST ,GridBagConstraints.BOTH, new Insets(8,8,8,8), 0, 0));</span>
        
<span class="nc" id="L113">        cont.add( ignore,       new GridBagConstraints( 3, 1, 1, 1, 0.0, 0.0, GridBagConstraints.NORTHWEST ,GridBagConstraints.HORIZONTAL, insetR, 0, 0));</span>
<span class="nc" id="L114">        cont.add( ignoreAll,    new GridBagConstraints( 3, 2, 1, 1, 0.0, 0.0, GridBagConstraints.NORTHWEST ,GridBagConstraints.HORIZONTAL, insetR, 0, 0));</span>
<span class="nc" id="L115">        cont.add( addToDic,     new GridBagConstraints( 3, 3, 1, 1, 0.0, 0.0, GridBagConstraints.NORTHWEST ,GridBagConstraints.HORIZONTAL, insetR, 0, 0));</span>
<span class="nc" id="L116">        cont.add( editDic,      new GridBagConstraints( 3, 4, 1, 1, 0.0, 0.0, GridBagConstraints.NORTHWEST ,GridBagConstraints.HORIZONTAL, insetR, 0, 0));</span>
<span class="nc" id="L117">        cont.add( change,       new GridBagConstraints( 3, 5, 1, 1, 0.0, 0.0, GridBagConstraints.NORTHWEST ,GridBagConstraints.HORIZONTAL, insetR, 0, 0));</span>
<span class="nc" id="L118">        cont.add( changeAll,    new GridBagConstraints( 3, 6, 1, 1, 0.0, 0.0, GridBagConstraints.NORTHWEST ,GridBagConstraints.HORIZONTAL, insetR, 0, 0));</span>
<span class="nc" id="L119">        cont.add( about,        new GridBagConstraints( 3, 7, 1, 1, 0.0, 0.0, GridBagConstraints.NORTHWEST ,GridBagConstraints.HORIZONTAL, insetR, 0, 0));</span>
<span class="nc" id="L120">        cont.add( close,        new GridBagConstraints( 3, 8, 1, 1, 0.0, 0.0, GridBagConstraints.NORTHWEST ,GridBagConstraints.HORIZONTAL, insetR, 0, 0));</span>
<span class="nc" id="L121">        cont.add( Utils.getLabel( null ), new GridBagConstraints( 3, 9, 1, 1, 0.0, 1.0, GridBagConstraints.NORTHWEST ,GridBagConstraints.HORIZONTAL, insetR, 0, 0));</span>
        
<span class="nc" id="L123">        ignore.addActionListener(this);</span>
<span class="nc" id="L124">        ignoreAll.addActionListener(this);</span>
<span class="nc" id="L125">        addToDic.addActionListener(this);</span>
<span class="nc" id="L126">        editDic.addActionListener(this);</span>
<span class="nc" id="L127">        change.addActionListener(this);</span>
<span class="nc" id="L128">        changeAll.addActionListener(this);</span>
<span class="nc" id="L129">        about.addActionListener(this);</span>
<span class="nc" id="L130">        close.addActionListener(this);</span>
        
        //ESCAPE Taste
<span class="nc" id="L133">        close.getInputMap( JComponent.WHEN_IN_FOCUSED_WINDOW ).put( KeyStroke.getKeyStroke( KeyEvent.VK_ESCAPE, 0, false ), &quot;ESCAPE&quot; );</span>
<span class="nc" id="L134">        close.getActionMap().put( &quot;ESCAPE&quot;, new AbstractAction() {</span>
            public void actionPerformed( ActionEvent e ) {
<span class="nc" id="L136">                dispose();</span>
<span class="nc" id="L137">            }</span>
        } );
        
<span class="nc" id="L140">        word.getDocument().addDocumentListener(new DocumentListener(){</span>
            public void changedUpdate(DocumentEvent ev){
                // disable &quot;Add To Dictionary&quot; if word was changed, not this word would added else the original misspelled word
<span class="nc" id="L143">                addToDic.setEnabled( false );</span>
<span class="nc" id="L144">            }</span>
            public void insertUpdate(DocumentEvent ev){
                // disable &quot;Add To Dictionary&quot; if word was changed, not this word would added else the original misspelled word
<span class="nc" id="L147">                addToDic.setEnabled( false );</span>
<span class="nc" id="L148">            }</span>
            public void removeUpdate(DocumentEvent ev){
                // disable &quot;Add To Dictionary&quot; if word was changed, not this word would added else the original misspelled word
<span class="nc" id="L151">                addToDic.setEnabled( false );</span>
<span class="nc" id="L152">            }</span>
        });
        
<span class="nc" id="L155">        suggestionsList.addListSelectionListener(new ListSelectionListener(){</span>
            public void valueChanged(ListSelectionEvent ev){
                // Update the word field if a suggestion is click
<span class="nc bnc" id="L158" title="All 4 branches missed.">                if( !ev.getValueIsAdjusting() &amp;&amp; suggestionsList.getSelectedIndex() &gt;= 0 ){</span>
<span class="nc" id="L159">                    word.setText( (String)suggestionsList.getSelectedValue() );</span>
<span class="nc" id="L160">                    addToDic.setEnabled( true );</span>
                }
<span class="nc" id="L162">            }</span>
        });
        
<span class="nc" id="L165">        suggestionsList.addMouseListener( new MouseAdapter() {</span>
            @Override
            public void mouseClicked( MouseEvent e ) {
<span class="nc bnc" id="L168" title="All 4 branches missed.">                if( e.getClickCount() == 2 &amp;&amp; e.getButton() == MouseEvent.BUTTON1 ) {</span>
                    // Change the word on a double click
<span class="nc bnc" id="L170" title="All 2 branches missed.">                    if( suggestionsList.getSelectedIndex() &gt;= 0 ) {</span>
<span class="nc" id="L171">                        word.setText( (String)suggestionsList.getSelectedValue() );</span>
<span class="nc" id="L172">                        actionPerformed( new ActionEvent( suggestionsList, 0, null ) );</span>
                    }
                }
<span class="nc" id="L175">            }</span>
        } );

<span class="nc bnc" id="L178" title="All 2 branches missed.">        boolean isUserDictionary = SpellChecker.getUserDictionaryProvider() != null;</span>
<span class="nc" id="L179">        addToDic.setEnabled( isUserDictionary );</span>
<span class="nc" id="L180">        editDic.setEnabled( isUserDictionary );</span>
<span class="nc" id="L181">        pack();</span>
<span class="nc" id="L182">    }</span>
    
    
    public void show( JTextComponent jTextComponent, Dictionary dic, Locale loc ) {
<span class="nc" id="L186">        this.jText = jTextComponent;</span>
<span class="nc" id="L187">        this.dictionary = dic;</span>
<span class="nc" id="L188">        change.requestFocus();</span>
<span class="nc" id="L189">        setTitle( Utils.getResource(&quot;spelling&quot;) + &quot;: &quot; + loc.getDisplayLanguage() );</span>

<span class="nc" id="L191">        tok = new Tokenizer( jTextComponent, dic, loc, options );</span>
        
<span class="nc bnc" id="L193" title="All 2 branches missed.">        if( searchNext() ){</span>
            // if the JTextComponent is large and has a scrollpane then Java use the bounds
            // and not the visible rect. This is bad
<span class="nc" id="L196">            Container parent = jTextComponent;</span>
<span class="nc bnc" id="L197" title="All 4 branches missed.">            while( parent != null &amp;&amp; !(parent instanceof JScrollPane) ) {</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">                if( parent instanceof JComponent ) {</span>
<span class="nc" id="L199">                    JComponent jcomp = (JComponent)parent;</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">                    if( jcomp.getVisibleRect().height == jcomp.getBounds().height ) {</span>
<span class="nc" id="L201">                        break;</span>
                    }
                }
<span class="nc bnc" id="L204" title="All 2 branches missed.">                if( parent.getParent() != null ) {</span>
<span class="nc" id="L205">                    parent = parent.getParent();</span>
                } else {
                    break;
                }
            }
            
<span class="nc" id="L211">            setLocationRelativeTo( parent );</span>
<span class="nc" id="L212">            setVisible( true );</span>
        }
<span class="nc" id="L214">    }</span>
    
    /**
     * Search the next misspelling word. If found it then refresh the dialog with the new information.
     * ignoreWords and changeWords will handle automatically.
     * @return true, if found a spell error.
     */
    private boolean searchNext() {
        String wordStr;
<span class="nc" id="L223">        while( true ) {</span>
<span class="nc" id="L224">            wordStr = tok.nextInvalidWord();</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">            if( wordStr == null ) {</span>
<span class="nc" id="L226">                dispose();</span>
<span class="nc" id="L227">                String title = SpellChecker.getApplicationName();</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">                if(title == null){</span>
<span class="nc" id="L229">                    title = this.getTitle();</span>
                }
<span class="nc" id="L231">                SpellChecker.getMessageHandler().handleInformation( getParent(), title, Utils.getResource( &quot;msgFinish&quot; ) );</span>
<span class="nc" id="L232">                return false;</span>
            }
<span class="nc bnc" id="L234" title="All 2 branches missed.">            if( ignoreWords.contains( wordStr ) ) {</span>
<span class="nc" id="L235">                continue;</span>
            }
<span class="nc" id="L237">            String changeTo = changeWords.get( wordStr );</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">            if( changeTo != null ) {</span>
<span class="nc" id="L239">                replaceWord( wordStr, changeTo );</span>
                continue;
            }
            break;
        }
<span class="nc" id="L244">        word.setText( wordStr );</span>
<span class="nc" id="L245">        notFound.setText( wordStr );</span>

<span class="nc" id="L247">        List&lt;Suggestion&gt; list = dictionary.searchSuggestions( wordStr );</span>
        
<span class="nc bnc" id="L249" title="All 4 branches missed.">        boolean needCapitalization = tok.isFirstWordInSentence() &amp;&amp; Utils.isFirstCapitalized( wordStr );</span>

<span class="nc" id="L251">        Vector&lt;String&gt; suggestionsVector = new Vector&lt;String&gt;();</span>
<span class="nc bnc" id="L252" title="All 4 branches missed.">        for( int i = 0; i &lt; list.size() &amp;&amp; i &lt; options.getSuggestionsLimitDialog(); i++ ) {</span>
<span class="nc" id="L253">            Suggestion sugestion = list.get( i );</span>
<span class="nc" id="L254">            String newWord = sugestion.getWord();</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">            if( needCapitalization ) {</span>
<span class="nc" id="L256">                newWord = Utils.getCapitalized( newWord );</span>
            }
<span class="nc bnc" id="L258" title="All 2 branches missed.">            if( i == 0 )</span>
<span class="nc" id="L259">                word.setText( newWord );</span>
<span class="nc" id="L260">            suggestionsVector.add( newWord );</span>
        }
<span class="nc" id="L262">        suggestionsList.setListData( suggestionsVector );</span>
        
<span class="nc" id="L264">        addToDic.setEnabled( true );</span>
<span class="nc" id="L265">        return true;</span>
    }
    
    
    public void actionPerformed( ActionEvent ev ) {
<span class="nc" id="L270">        Object source = ev.getSource();</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">        if( source == ignore ) {</span>
<span class="nc" id="L272">            searchNext();</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">        } else if( source == about ) {</span>
<span class="nc" id="L274">            new AboutDialog( this ).setVisible( true );</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">        } else if( source == close ) {</span>
<span class="nc" id="L276">            dispose();</span>
<span class="nc" id="L277">        } else{</span>
<span class="nc" id="L278">            String newWord = word.getText();</span>
<span class="nc" id="L279">            String oldWord = notFound.getText();</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">            if( source == ignoreAll ) {</span>
<span class="nc" id="L281">                ignoreWords.add( oldWord );</span>
<span class="nc" id="L282">                searchNext();</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">            } else if( source == addToDic ) {</span>
<span class="nc" id="L284">                UserDictionaryProvider provider = SpellChecker.getUserDictionaryProvider();</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">                if( provider != null ) {</span>
<span class="nc" id="L286">                    provider.addWord( oldWord );</span>
                }
<span class="nc" id="L288">                dictionary.add( oldWord );</span>
<span class="nc" id="L289">                dictionary.trimToSize();</span>
<span class="nc" id="L290">                isDictionaryModify = true;</span>
<span class="nc" id="L291">                searchNext();</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">            } else if( source == editDic ) {</span>
<span class="nc" id="L293">                new DictionaryEditDialog( this ).setVisible( true );</span>
<span class="nc bnc" id="L294" title="All 4 branches missed.">            } else if( source == change || source == suggestionsList ) {</span>
<span class="nc" id="L295">                replaceWord( oldWord, newWord );</span>
<span class="nc" id="L296">                searchNext();</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">            } else if( source == changeAll ) {</span>
<span class="nc" id="L298">                changeWords.put( oldWord, newWord );</span>
<span class="nc" id="L299">                replaceWord( oldWord, newWord );</span>
<span class="nc" id="L300">                searchNext();</span>
            }
        }
<span class="nc" id="L303">    }</span>
    
    private void replaceWord( String oldWord, String newWord ) {
<span class="nc" id="L306">        jText.setSelectionStart( tok.getWordOffset() );</span>
<span class="nc" id="L307">        jText.setSelectionEnd( tok.getWordOffset() + oldWord.length() );</span>
<span class="nc" id="L308">        jText.replaceSelection( newWord );</span>
<span class="nc" id="L309">        tok.updatePhrase();</span>
<span class="nc" id="L310">    }</span>


    @Override
    public void dispose(){
<span class="nc" id="L315">        super.dispose();</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">        if( isDictionaryModify ){</span>
<span class="nc" id="L317">            AutoSpellChecker.refresh( jText );</span>
        }
<span class="nc" id="L319">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span>AllTests (07-Apr-2019 21:21:31)</div></body></html>